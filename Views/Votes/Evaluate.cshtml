@model VoteEvaluationViewModel
@{
    ViewData["Title"] = "Оцінити: " + Model.VoteTitle;
    int alternativeId = -1;
}

<h2>@ViewData["Title"]</h2>
@if (!string.IsNullOrEmpty(Model.Description))
{
    <div class="vote-description mb-4">
        <p class="lead">@Model.Description</p>
    </div>
}

<form asp-action="Evaluate" id="evaluationForm">
    <input type="hidden" asp-for="VoteId" />
    <input type="hidden" asp-for="Description" />
    <input type="hidden" asp-for="IsPrivate" />
    <input type="hidden" asp-for="VoteTitle" />

    <!-- Drag & Drop Block for Alternative Positioning -->
    <div class="alternative-ordering mb-4">
        <h4>Впорядкування альтернатив</h4>
        <p class="text-muted">Перетягніть альтернативи для встановлення їх позиції у списку</p>

        <div class="alternatives-list border p-3" id="alternativesContainer">
            @foreach (var alternative in Model.Alternatives)
            {
                <div class="alternative-item draggable border p-2 mb-2 bg-light"
                     data-alternative-id="@alternative.Id"
                     style="cursor: grab; user-select: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="alternative-title">@alternative.Title</span>
                        <span class="badge badge-secondary handle">≡</span>
                    </div>
                    <input type="hidden" name="AlternativePositions[@alternative.Id]"
                           class="order-input" value="@alternative.Id" />
                </div>
            }
        </div>
        <small class="form-text text-muted">
            Позиція 1 - найвищий пріоритет, @Model.Alternatives.Count() - найнижчий
        </small>
    </div>

    @for (int i = 0; i < Model.Criteria.Count; i++)
    {
        var isNew = Model.Alternatives.Count() > 0 && alternativeId != Model.Criteria[i].DBVoteAlternativeId && Model.Criteria[i].DBVoteAlternativeId != null;
        alternativeId = isNew ? Model.Criteria[i].DBVoteAlternativeId : alternativeId;
        var alternative = isNew ? Model.Alternatives.Where((item) => item.Id == Model.Criteria[i].DBVoteAlternativeId).First() : null;
        <h3> @(isNew ? ("Альтернатива: " + @alternative?.Title) : "") </h3>
        <div class="criteria-item border p-3 mb-3">
            <input type="hidden" asp-for="Criteria[i].SettingsId" />
            <input type="hidden" asp-for="Criteria[i].MinValue" />
            <input type="hidden" asp-for="Criteria[i].MaxValue" />
            <input type="hidden" asp-for="Criteria[i].DBVoteAlternativeId" />
            <input type="hidden" asp-for="Criteria[i].Title" />
            <input type="hidden" asp-for="Criteria[i].Description" />
            <input type="hidden" asp-for="Criteria[i].ImportanceValue" />
            <div class="row">
                <div class="col-md-12">
                    <h5>@Model.Criteria[i].Title</h5>
                    <div class="form-group">
                        <label asp-for="Criteria[i].Value" class="control-label"></label>
                        <input type="number" asp-for="Criteria[i].Value" class="form-control criteria-value-input"
                               min="@Model.Criteria[i].MinValue" max="@Model.Criteria[i].MaxValue" step="@Model.Criteria[i].StepValue"
                               data-criteria-index="@i" />
                        <small class="form-text text-muted">
                            Значення повинно міститьсь в діапазоні від @Model.Criteria[i].MinValue до @Model.Criteria[i].MaxValue. @Model.Criteria[i].Description
                        </small>
                        <span asp-validation-for="Criteria[i].Value" class="text-danger"></span>

                        <!-- Value control buttons -->
                        <div class="criteria-controls mt-2">
                            <div class="btn-group btn-group-sm mb-2" role="group">
                                <button type="button" class="btn btn-outline-secondary criteria-decrement" data-index="@i">-</button>
                                <button type="button" class="btn btn-outline-secondary criteria-increment" data-index="@i">+</button>
                            </div>

                            <div class="btn-group btn-group-sm mb-2" role="group">
                                <button type="button" class="btn btn-outline-primary set-min-value" data-index="@i">Min (@Model.Criteria[i].MinValue)</button>
                                <button type="button" class="btn btn-outline-primary set-max-value" data-index="@i">Max (@Model.Criteria[i].MaxValue)</button>
                            </div>

                            <div class="quick-values mt-2">
                                @{
                                    var stepValue = Model.Criteria[i].StepValue;
                                    var maxValue = Model.Criteria[i].MaxValue;
                                    var buttonCount = (int)Math.Ceiling(maxValue / stepValue) + 1;

                                    for (int j = 0; j <= buttonCount; j++)
                                    {
                                        var value = j * stepValue;
                                        if (value <= maxValue)
                                        {
                                            <button type="button" class="btn btn-outline-info btn-sm quick-value-btn mr-1 mb-1"
                                                    data-index="@i" data-value="@value">
                                                @value
                                            </button>
                                        }
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    <div class="form-group">
        <input type="submit" value="Оцінити" class="btn btn-primary" />
        <a asp-action="Index" class="btn btn-secondary">Скасувати</a>
    </div>
</form>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('alternativesContainer');
            let draggedItem = null;

            // Initialize drag and drop
            function initializeDragAndDrop() {
                const items = container.querySelectorAll('.draggable');

                items.forEach(item => {
                    item.setAttribute('draggable', 'true');

                    item.addEventListener('dragstart', function(e) {
                        draggedItem = item;
                        setTimeout(() => {
                            item.classList.add('dragging');
                        }, 0);
                    });

                    item.addEventListener('dragend', function() {
                        draggedItem = null;
                        item.classList.remove('dragging');
                        updateOrder();
                    });

                    item.addEventListener('dragover', function(e) {
                        e.preventDefault();
                    });

                    item.addEventListener('dragenter', function(e) {
                        e.preventDefault();
                        if (item !== draggedItem) {
                            item.classList.add('drag-over');
                        }
                    });

                    item.addEventListener('dragleave', function() {
                        item.classList.remove('drag-over');
                    });

                    item.addEventListener('drop', function(e) {
                        e.preventDefault();
                        item.classList.remove('drag-over');

                        if (item !== draggedItem) {
                            const allItems = Array.from(container.querySelectorAll('.draggable'));
                            const draggedIndex = allItems.indexOf(draggedItem);
                            const targetIndex = allItems.indexOf(item);

                            if (draggedIndex < targetIndex) {
                                item.parentNode.insertBefore(draggedItem, item.nextSibling);
                            } else {
                                item.parentNode.insertBefore(draggedItem, item);
                            }

                            updateOrder();
                        }
                    });
                });
            }

            // Update the order of alternatives
            function updateOrder() {
                const items = container.querySelectorAll('.draggable');

                items.forEach((item, index) => {
                    const position = index + 1;

                    // Update hidden input for this alternative
                    const orderInput = item.querySelector('.order-input');
                    if (orderInput) {
                        orderInput.value = position;
                    }
                });
            }

            // Criteria value controls
            function initializeCriteriaControls() {
                // Increment button
                document.querySelectorAll('.criteria-increment').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        const input = document.querySelector(`input[data-criteria-index="${index}"]`);
                        const step = parseFloat(input.getAttribute('step')) || 1;
                        const max = parseFloat(input.getAttribute('max'));
                        let currentValue = parseFloat(input.value) || 0;

                        const newValue = Math.min(currentValue + step, max);
                        input.value = newValue;
                        input.dispatchEvent(new Event('change'));
                    });
                });

                // Decrement button
                document.querySelectorAll('.criteria-decrement').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        const input = document.querySelector(`input[data-criteria-index="${index}"]`);
                        const step = parseFloat(input.getAttribute('step')) || 1;
                        const min = parseFloat(input.getAttribute('min'));
                        let currentValue = parseFloat(input.value) || 0;

                        const newValue = Math.max(currentValue - step, min);
                        input.value = newValue;
                        input.dispatchEvent(new Event('change'));
                    });
                });

                // Set min value
                document.querySelectorAll('.set-min-value').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        const input = document.querySelector(`input[data-criteria-index="${index}"]`);
                        const min = parseFloat(input.getAttribute('min'));
                        input.value = min;
                        input.dispatchEvent(new Event('change'));
                    });
                });

                // Set max value
                document.querySelectorAll('.set-max-value').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        const input = document.querySelector(`input[data-criteria-index="${index}"]`);
                        const max = parseFloat(input.getAttribute('max'));
                        input.value = max;
                        input.dispatchEvent(new Event('change'));
                    });
                });

                // Quick value buttons
                document.querySelectorAll('.quick-value-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        const value = parseFloat(this.getAttribute('data-value'));
                        const input = document.querySelector(`input[data-criteria-index="${index}"]`);
                        input.value = value;
                        input.dispatchEvent(new Event('change'));
                    });
                });
            }

            // Initialize when page loads
            initializeDragAndDrop();
            initializeCriteriaControls();
        });
    </script>

    <style>
        .draggable.dragging {
            opacity: 0.5;
            background-color: #e9ecef;
        }

        .draggable.drag-over {
            border: 2px dashed #007bff;
            background-color: #f8f9fa;
        }

        .alternative-item {
            transition: all 0.2s ease;
        }

        .handle {
            cursor: grab;
            font-size: 1.2em;
        }

        .draggable:active .handle {
            cursor: grabbing;
        }

        .criteria-controls {
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
        }

        .quick-values {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .quick-value-btn {
            min-width: 40px;
        }
    </style>
}